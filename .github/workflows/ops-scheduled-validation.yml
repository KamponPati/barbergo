name: ops-scheduled-validation

on:
  schedule:
    - cron: "15 18 * * *" # daily 01:15 Asia/Bangkok (nightly smoke)
    - cron: "30 19 * * 0" # weekly 02:30 Asia/Bangkok Sunday (full e2e)
  workflow_dispatch:
    inputs:
      mode:
        description: "nightly-smoke or weekly-e2e"
        required: false
        default: "nightly-smoke"

permissions:
  contents: read
  issues: write

jobs:
  nightly-smoke:
    if: github.event_name == 'schedule' || github.event.inputs.mode == 'nightly-smoke'
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run nightly smoke critical journeys
        env:
          API_BASE_URL: ${{ secrets.STAGING_API_URL }}
          WEB_BASE_URL: ${{ secrets.STAGING_WEB_URL }}
          SMOKE_ALLOW_INSECURE_TLS: "true"
        run: |
          mkdir -p artifacts/nightly-smoke
          bash scripts/staging/smoke-critical-journeys.sh 2>&1 | tee artifacts/nightly-smoke/smoke.log

      - name: Upload nightly report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-smoke-report
          path: artifacts/nightly-smoke
          retention-days: 14

      - name: Open incident issue on nightly failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[ops][nightly-smoke] failure ${new Date().toISOString()}`;
            const body = [
              "Nightly smoke validation failed.",
              "",
              `Workflow: ${context.workflow}`,
              `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              "",
              "Please triage and resolve before next schedule."
            ].join("\n");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["incident", "ops", "nightly-smoke"]
            });

  weekly-full-e2e:
    if: github.event_name == 'schedule' || github.event.inputs.mode == 'weekly-e2e'
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Generate Prisma client
        run: pnpm --filter @barbergo/api exec prisma generate

      - name: Run weekly full e2e regression
        env:
          API_BASE_URL: ${{ secrets.STAGING_API_URL }}
          WEB_BASE_URL: ${{ secrets.STAGING_WEB_URL }}
          SMOKE_ALLOW_INSECURE_TLS: "true"
          REPORT_DIR: artifacts/weekly-full-e2e
        run: bash scripts/staging/full-e2e-regression.sh

      - name: Upload weekly regression report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-full-e2e-report
          path: artifacts/weekly-full-e2e
          retention-days: 30

      - name: Open incident issue on weekly failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[ops][weekly-e2e] failure ${new Date().toISOString()}`;
            const body = [
              "Weekly full e2e regression failed.",
              "",
              `Workflow: ${context.workflow}`,
              `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              "",
              "Please triage this regression before production release approval."
            ].join("\n");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["incident", "ops", "weekly-e2e"]
            });
