name: release-prod

on:
  workflow_dispatch:
    inputs:
      api_base_url:
        description: "Production API base URL (example: https://api.example.com/api/v1)"
        required: true
      web_base_url:
        description: "Production Web URL (example: https://app.example.com)"
        required: true
      release_id:
        description: "Release identifier"
        required: true

concurrency:
  group: release-prod
  cancel-in-progress: false

jobs:
  predeploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20
    outputs:
      release_id: ${{ github.event.inputs.release_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Generate Prisma client
        run: pnpm --filter @barbergo/api exec prisma generate

      - name: Predeploy gate
        run: bash scripts/release/predeploy-gate.sh

  deploy-and-verify:
    runs-on:
      - self-hosted
      - linux
    environment: production
    needs: predeploy
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Deploy canary (hook)
        run: bash scripts/release/deploy-canary-local.sh

      - name: Production smoke verification
        env:
          # On self-hosted runner, verify local origin directly to avoid Cloudflare Access/WAF blocking (403).
          API_BASE_URL: "http://127.0.0.1:3000/api/v1"
          WEB_BASE_URL: "http://127.0.0.1:5173"
          SMOKE_ALLOW_INSECURE_TLS: "true"
        run: bash scripts/staging/smoke-critical-journeys.sh

      - name: Promote full rollout (hook)
        run: bash scripts/release/promote-full-local.sh

      - name: Rollback on failure (hook)
        if: failure()
        run: bash scripts/release/rollback-local.sh
